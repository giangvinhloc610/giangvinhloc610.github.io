<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>gpteye</title>
</head>
<body>
  <div>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <p id="cap0"></p>
    <p id="cap1"></p>
    <p id="cap2"></p>
    <p id="cap3"></p>
    <p id="cap4"></p>
    <button onclick="captureFrame();">Capture Frame</button>
  </div>

  <div>
    <p id="chatlog"></p>
    <textarea id="chatbox" rows="10" cols="80"></textarea>
    <button onclick="send_chatbox();">Send</button>
  </div>

  <script>
    // JSON storing chat history
    var chatpl = {
      "messages": [{
        "role": "system",
        "content": "You are ChatGPT, a large language model trained by OpenAI.\nYou are being provided information from a bot. The bot will capture image from user's camera, send it to a CV model generating caption of the image. Multiple captions are NOT describing multiple scenes or pictures, but the same picture. The bot will also provide you what the user said.\nYou must response like you are talking with the user, not with the bot."
      }],
      "model": "gpt-3.5-turbo",
      "temperature": 1,
      "presence_penalty": 0,
      "top_p": 1,
      "frequency_penalty": 0
    }

    // Access the user's camera and stream video to the video element
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(function(stream) {
        var videoElement = document.getElementById('video');
        videoElement.srcObject = stream;
      })
      .catch(function(error) {
        console.error('Error accessing the camera.', error);
      });

    // Send message to ChatGPT
    function chat(msg, log) {
      if (log) {
        // Show message on chatlog
        document.getElementById("chatlog").innerHTML += "<b>User:</b> " + msg + "<br>";
        msg = "The user said: `" + msg + "`. Remember you are talking with the user, so use pronoun words properly.";
      }

      // Add message to chat payload
      chatpl["messages"].push({"role": "user", "content": msg});

      // Send POST request with JSON payload
      fetch("https://free.churchless.tech/v1/chat/completions", {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer MyDiscord',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(chatpl)
      })
        .then(response => response.json()) // Parse response as JSON
        .then(data => {
          // Add response to chat payload
          chatpl["messages"].push(data["choices"][0]["message"]);
          document.getElementById("chatlog").innerHTML += "<b>Bot:</b> " + data["choices"][0]["message"]["content"] + "<br>";
        })
        .catch(error => {
          // Handle error
          console.error('Error:', error);
        });
    }

    // Submit the message in chatbox
    function send_chatbox() {
      var msg = document.getElementById("chatbox").value;
      document.getElementById("chatbox").value = "";
      chat(msg, true);
    }

    // Capture a frame from the video stream and encode it
    function captureFrame() {
      var videoElement = document.getElementById('video');
      var canvasElement = document.getElementById('canvas');
      var context = canvasElement.getContext('2d');

      // Set canvas dimensions to match video element
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;

      // Draw the current frame from the video element onto the canvas
      context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

      // Convert the canvas image to a data URL representation of a JPEG image
      var dataUrl = canvasElement.toDataURL('image/jpeg');

      // Create payload
      var payload = {
        fn_index: 0,
        data: [dataUrl],
        session_hash: 'cmytyp1g88u'
      };

      // Establish a WebSocket connection
      var socket = new WebSocket('wss://devnsketch-comparing-caption-models-rich.hf.space/queue/join');

      // Handle messages received from the server
      socket.onmessage = function(event) {
        var message = JSON.parse(event.data);

        if (message.msg === 'send_hash') {
          // Send the session hash
          socket.send('{"session_hash":"cmytyp1g88u","fn_index":0}');
        } else if (message.msg === 'send_data') {
          // Send the payload
          socket.send(JSON.stringify(payload));
        } else if (message.msg === 'process_completed') {
          // Assume it's the result message
          var result = JSON.parse(event.data);
          var msg = "Auto generated captions (by bots, not what the user describe) of image from the user's camera: ";
          for (var i = 0; i <= 4; i++) {
            //document.getElementById("cap" + i.toString()).innerText = result["output"]["data"][i];
            msg += "`" + result["output"]["data"][i] + (i == 4 ? "`" : "`, ");
          }

          msg += "\nThese are multiple descriptions of the same scene, try to think it as the same scene but many ways to describe. Pretent that you actually \"see\" the scene, not just looking it through images and descriptions. Describe what you can \"see\" in the user's scene through the description. Try to guess what the user's doing or where the user is. Ask questions you want to clarify about the scene, actions,... Remember you are talking to the user, so use pronoun words properly. If the description talk about only one person, that's likely to be the user. Images (but not descriptions) are continuous, so if there is another picture described, they are related to the last picture.";

          chat(msg, false);
        }
      };

      // Handle WebSocket errors
      socket.onerror = function(error) {
        console.error('WebSocket error:', error);
      };

      // Close the WebSocket connection when the frame is sent
      socket.onclose = function() {
        console.log('WebSocket connection closed');
      };
    }
  </script>
</body>
</html>